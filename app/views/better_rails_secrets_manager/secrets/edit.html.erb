<div class="bg-white rounded-lg card-shadow p-6">
  <div class="flex justify-between items-center mb-6">
    <% 
      display_env = case current_environment
      when 'credentials'
        'Main Credentials'
      else
        current_environment.humanize.capitalize + ' Secrets'
      end
    %>
    <h2 class="text-2xl font-bold">Edit <%= display_env %> (YAML Mode)</h2>
    <div class="space-x-2">
      <%= link_to "← Back", root_path, class: "link-primary" %>
      <%= link_to "Switch to Form Editor", edit_path, class: "link-secondary text-sm" %>
    </div>
  </div>
  
  <%= form_with url: update_path, local: true, id: 'secrets-form' do |f| %>
    <div class="mb-4">
      <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4 rounded">
        <p class="text-sm text-blue-700">
          Edit your secrets in YAML format below. Use proper indentation for nested values.
        </p>
      </div>
      
      <%= f.text_area :secrets, 
          value: @formatted_secrets,
          class: "w-full",
          id: "secrets-editor",
          rows: 20 %>
    </div>
    
    <div class="flex space-x-4">
      <%= f.submit "Save Secrets", class: "btn-success" %>
      <%= link_to "Cancel", root_path, class: "btn-secondary" %>
      
      <div class="ml-auto space-x-2">
        <button type="button" onclick="formatYAML()" class="btn-outline">Format YAML</button>
        <button type="button" onclick="validateYAML()" class="btn-outline">Validate</button>
      </div>
    </div>
  <% end %>
</div>

<style>
  .CodeMirror {
    height: 500px;
    max-height: 70vh;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
  }
  .CodeMirror-scroll {
    max-height: 70vh;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var textArea = document.getElementById('secrets-editor');
    var editor = CodeMirror.fromTextArea(textArea, {
      mode: 'yaml',
      theme: 'monokai',
      lineNumbers: true,
      lineWrapping: true,
      indentUnit: 2,
      tabSize: 2,
      indentWithTabs: false,
      autofocus: true,
      extraKeys: {
        "Tab": function(cm) {
          cm.replaceSelection("  ", "end");
        }
      }
    });
    
    window.cmEditor = editor;
    
    // Update the hidden textarea before form submission
    document.getElementById('secrets-form').addEventListener('submit', function(e) {
      textArea.value = editor.getValue();
    });
  });
  
  function formatYAML() {
    try {
      var value = window.cmEditor.getValue();
      // Basic YAML formatting
      var lines = value.split('\n');
      var formatted = lines.map(function(line) {
        return line.replace(/\t/g, '  ');
      }).join('\n');
      window.cmEditor.setValue(formatted);
    } catch(e) {
      alert('Error formatting YAML: ' + e.message);
    }
  }
  
  function validateYAML() {
    try {
      var value = window.cmEditor.getValue();
      // Basic validation - check for common YAML issues
      if (value.includes('\t')) {
        alert('Warning: YAML should use spaces, not tabs for indentation');
        return;
      }
      
      var lines = value.split('\n');
      var indentErrors = [];
      
      lines.forEach(function(line, index) {
        if (line.length > 0 && !line.match(/^( {2})*[^ ]/)) {
          indentErrors.push('Line ' + (index + 1) + ': Invalid indentation');
        }
      });
      
      if (indentErrors.length > 0) {
        alert('Validation errors:\n' + indentErrors.join('\n'));
      } else {
        alert('YAML appears valid!');
      }
    } catch(e) {
      alert('Validation error: ' + e.message);
    }
  }
</script>
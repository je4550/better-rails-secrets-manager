<div class="bg-white rounded-lg card-shadow p-6">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold">Edit <%= current_environment.capitalize %> Secrets</h2>
    <%= link_to "← Back", root_path, class: "text-indigo-600 hover:text-indigo-800" %>
  </div>
  
  <%= form_with url: update_path, local: true do |f| %>
    <div class="mb-4">
      <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
        <p class="text-sm text-blue-700">
          Edit your secrets in YAML format below. Use proper indentation for nested values.
        </p>
      </div>
      
      <%= f.text_area :secrets, 
          value: @formatted_secrets,
          class: "w-full",
          id: "secrets-editor",
          rows: 20 %>
    </div>
    
    <div class="flex space-x-4">
      <%= f.submit "Save Secrets", class: "btn-success" %>
      <%= link_to "Cancel", root_path, class: "btn-secondary" %>
      
      <div class="ml-auto space-x-2">
        <button type="button" onclick="formatYAML()" class="btn-primary">Format YAML</button>
        <button type="button" onclick="validateYAML()" class="btn-secondary">Validate</button>
      </div>
    </div>
  <% end %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var editor = CodeMirror.fromTextArea(document.getElementById('secrets-editor'), {
      mode: 'yaml',
      theme: 'monokai',
      lineNumbers: true,
      lineWrapping: true,
      indentUnit: 2,
      tabSize: 2,
      indentWithTabs: false,
      autofocus: true,
      extraKeys: {
        "Tab": function(cm) {
          cm.replaceSelection("  ", "end");
        }
      }
    });
    
    window.cmEditor = editor;
  });
  
  function formatYAML() {
    try {
      var value = window.cmEditor.getValue();
      // Basic YAML formatting
      var lines = value.split('\n');
      var formatted = lines.map(function(line) {
        return line.replace(/\t/g, '  ');
      }).join('\n');
      window.cmEditor.setValue(formatted);
    } catch(e) {
      alert('Error formatting YAML: ' + e.message);
    }
  }
  
  function validateYAML() {
    try {
      var value = window.cmEditor.getValue();
      // Basic validation - check for common YAML issues
      if (value.includes('\t')) {
        alert('Warning: YAML should use spaces, not tabs for indentation');
        return;
      }
      
      var lines = value.split('\n');
      var indentErrors = [];
      
      lines.forEach(function(line, index) {
        if (line.length > 0 && !line.match(/^( {2})*[^ ]/)) {
          indentErrors.push('Line ' + (index + 1) + ': Invalid indentation');
        }
      });
      
      if (indentErrors.length > 0) {
        alert('Validation errors:\n' + indentErrors.join('\n'));
      } else {
        alert('YAML appears valid!');
      }
    } catch(e) {
      alert('Validation error: ' + e.message);
    }
  }
</script>